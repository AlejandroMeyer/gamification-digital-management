<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IT Governance: The Directors' Cut</title>
    <!-- Icon for page -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    <!-- Allowed External Resource: jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Fonts: Press Start 2P (Pixel) and Share Tech Mono (Tech) -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050a14;
            --bg-light: #10182e;
            --neon-cyan: #00f3ff;
            --neon-pink: #ff0055;
            --neon-yellow: #ffe600;
            --neon-green: #00ff66;
            --glass: rgba(16, 24, 46, 0.8);
            --glass-border: rgba(0, 243, 255, 0.3);
            --font-title: 'Press Start 2P', cursive;
            --font-body: 'Share Tech Mono', monospace;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(180deg, var(--bg-light) 0%, var(--bg-dark) 100%);
            color: white;
            font-family: var(--font-body);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        /* Red Background for Defeat */
        body.defeat-mode {
            background: linear-gradient(180deg, #4a0010 0%, #1a0005 100%);
        }

        /* Blue Background for Victory */
        body.victory-mode {
            background: linear-gradient(180deg, #002244 0%, #000510 100%);
        }

        /* --- Typography & Utilities --- */
        .title-font { font-family: var(--font-title); font-weight: 400; line-height: 1.5; }
        .text-cyan { color: var(--neon-cyan); text-shadow: 2px 2px 0px rgba(0,0,0,0.5); }
        .text-pink { color: var(--neon-pink); text-shadow: 2px 2px 0px rgba(0,0,0,0.5); }
        .text-yellow { color: var(--neon-yellow); }
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .column { flex-direction: column; }
        .full-screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        
        /* --- UI Components --- */
        .btn {
            background: var(--neon-yellow);
            color: #000;
            border: none;
            padding: 1rem 2rem;
            border-radius: 30px; /* Pill shape for main action buttons */
            font-family: var(--font-title);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 0 15px var(--neon-yellow);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            top: 0;
        }
        .btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 0 25px var(--neon-yellow); }
        .btn:active:not(:disabled) { top: 2px; }
        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(1);
            box-shadow: none !important;
        }
        
        .btn-cyan { background: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan); }
        .btn-cyan:hover:not(:disabled) { box-shadow: 0 0 25px var(--neon-cyan); }

        .btn-pink { background: transparent; border: 2px solid var(--neon-pink); color: var(--neon-pink); box-shadow: 0 0 10px rgba(255,0,85,0.3); }
        .btn-pink:hover:not(:disabled) { background: var(--neon-pink); color: white; box-shadow: 0 0 20px var(--neon-pink); }
        
        .btn-dark { background: #1a1a2e; color: white; border: 1px solid #444; box-shadow: none; }
        .btn-dark:hover:not(:disabled) { border-color: white; transform: scale(1.02); }

        .btn-white { background: white; color: #000; border: none; box-shadow: 0 0 15px rgba(255,255,255,0.5); }
        .btn-white:hover:not(:disabled) { box-shadow: 0 0 25px white; }

        .card {
            background: rgba(10, 15, 30, 0.95);
            border: 1px solid #333;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            max-width: 90%;
            width: 700px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        /* --- Audio Controls --- */
        #audio-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0,0,0,0.6);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #444;
        }
        #volume-slider { width: 80px; accent-color: var(--neon-cyan); }
        #mute-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0; }

        /* --- Screens --- */
        
        /* Neon Heartbeat Animation - Reduced Shine */
        @keyframes neon-heartbeat {
            0% { transform: scale(1); text-shadow: 0 0 5px var(--neon-cyan); opacity: 0.9; }
            50% { transform: scale(1.02); text-shadow: 0 0 15px var(--neon-cyan); opacity: 1; }
            100% { transform: scale(1); text-shadow: 0 0 5px var(--neon-cyan); opacity: 0.9; }
        }

        #start-screen h1 { 
            font-size: 3.5rem; 
            margin-bottom: 0.5rem; 
            text-align: center;
            line-height: 1.2;
            color: var(--neon-cyan);
            /* Apply Heartbeat Animation */
            animation: neon-heartbeat 2s ease-in-out infinite;
        }
        #start-screen h2 { font-size: 1rem; margin-bottom: 4rem; color: var(--neon-pink); letter-spacing: 2px; text-transform: uppercase; }

        /* Difficulty Grid */
        .difficulty-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; width: 100%; margin-top: 1rem; }
        .diff-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            padding: 2rem; 
            background: rgba(0, 243, 255, 0.05);
            border: 2px solid var(--neon-cyan);
            border-radius: 15px; /* Rounded Squares */
            cursor: pointer;
            transition: all 0.2s;
            height: 100%;
        }
        .diff-btn:hover { background: rgba(0, 243, 255, 0.15); transform: translateY(-3px); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
        .diff-title { font-family: var(--font-title); font-size: 0.9rem; color: var(--neon-yellow); margin-bottom: 1rem; line-height: 1.4; text-transform: uppercase;}
        .diff-meta { font-size: 0.9rem; color: #aaa; margin-bottom: 0.5rem; }
        .diff-hearts { font-size: 0.9rem; color: var(--neon-pink); font-weight: bold; }

        /* --- Game HUD --- */
        #game-screen { padding: 1rem; padding-top: 60px; display: flex; flex-direction: column; height: 100%; }
        .hud-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 0 10px; }
        .hearts-container { display: flex; gap: 8px; align-items: center; }
        
        /* UPDATED: Hearts back to Circles */
        .heart { 
            width: 28px; 
            height: 28px; 
            background: var(--neon-pink); 
            border-radius: 50%; /* Circle */
            box-shadow: 0 0 15px var(--neon-pink); 
            transition: all 0.3s; 
        }
        .heart.lost { 
            background: #555966; /* Grey when lost */
            box-shadow: inset 0 0 5px #222; 
        }
        
        #role-display { font-family: var(--font-title); font-size: 0.8rem; color: var(--neon-yellow); text-transform: uppercase; letter-spacing: 1px; }

        /* --- Race Track --- */
        .track-container { flex: 1; display: flex; flex-direction: column; gap: 15px; position: relative; margin-bottom: 1rem; padding: 0 10px; }
        .lane { 
            height: 35px; 
            background: rgba(255,255,255,0.03); 
            border-radius: 10px; 
            position: relative; 
            overflow: hidden; 
        }
        .lane.player { height: 50px; border: 1px solid var(--neon-cyan); background: rgba(0, 243, 255, 0.05); }
        .bar { 
            height: 100%; 
            width: 0%; 
            border-radius: 10px; 
            transition: width 0.3s linear; 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            padding-right: 15px;
            font-size: 0.8rem;
            font-family: var(--font-title);
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            white-space: nowrap;
        }
        .bar-player { background: linear-gradient(90deg, #0055ff, var(--neon-cyan)); color: #000; }
        .bar-bot-1 { background: linear-gradient(90deg, #550000, #ff0000); }
        .bar-bot-2 { background: linear-gradient(90deg, #553300, #ffaa00); }
        .bar-bot-3 { background: linear-gradient(90deg, #000055, #4444ff); }

        /* --- Orbs (Updated Style) --- */
        #orb-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 10; }
        .orb {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.1s;
        }
        .orb:active { transform: scale(0.9); }
        .orb-inner { width: 60%; height: 60%; border-radius: 50%; }

        /* Green Orb - Glowing Ring Style */
        .orb.green {
            background: rgba(0, 255, 102, 0.1);
            border: 3px solid #fff;
            box-shadow: 0 0 15px var(--neon-green), inset 0 0 10px var(--neon-green);
        }
        .orb.green .orb-inner { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }

        /* Red Orb - Glowing Ring Style */
        .orb.red {
            background: rgba(255, 0, 85, 0.1);
            border: 3px solid #ff99bb;
            box-shadow: 0 0 15px var(--neon-pink), inset 0 0 10px var(--neon-pink);
        }
        .orb.red .orb-inner { background: var(--neon-pink); box-shadow: 0 0 10px var(--neon-pink); }

        /* Grey Orb - Ring Style */
        .orb.grey {
            background: rgba(100, 100, 100, 0.1);
            border: 3px solid #aaa;
            box-shadow: 0 0 10px #888;
        }
        .orb.grey .orb-inner { background: #666; }


        /* --- Quiz Section --- */
        #quiz-container { 
            background: #0b1021; 
            border: 2px solid var(--neon-cyan); 
            border-radius: 20px; 
            padding: 2rem; 
            position: relative; 
            z-index: 20;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
        }
        #quiz-container.frozen { border-color: var(--neon-pink); box-shadow: 0 0 20px rgba(255, 0, 85, 0.2); animation: shake 0.5s; }
        
        .question-text { font-family: var(--font-title); font-size: 1rem; line-height: 1.6; margin-bottom: 1.5rem; color: white; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 1.2rem;
            border-radius: 12px;
            text-align: left;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            font-family: var(--font-body);
        }
        .option-btn:hover:not(:disabled) { background: rgba(0, 243, 255, 0.1); border-color: var(--neon-cyan); color: white; transform: translateY(-2px); }
        .option-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* --- Overlays & End Screens --- */
        .overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 50; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 18px;
            border: 2px solid var(--neon-pink);
            padding: 20px;
        }
        .freeze-msg { font-size: 2.5rem; color: var(--neon-pink); font-family: var(--font-title); margin-bottom: 1rem; text-shadow: 3px 3px 0 #500; letter-spacing: -2px; }
        
        .correct-answer-display { 
            margin-top: 1rem; padding: 1.2rem; 
            background: #111; border: 1px solid #333; border-radius: 10px; width: 90%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #freeze-label {
            font-size: 0.9rem; 
            color: #888; 
            font-family: var(--font-body); 
            margin-bottom: 10px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #freeze-correct-text {
            font-size: 1.1rem; /* Reduced from 2.2rem to handle long strings */
            line-height: 1.6;
            color: var(--neon-cyan);
            font-family: var(--font-title);
            text-align: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 100%;
        }

        /* --- End Screen Specifics --- */
        #end-screen h1 { font-size: 3rem; margin-bottom: 0.5rem; }
        .mission-analysis {
            border: 1px solid var(--neon-pink);
            background: rgba(255, 0, 85, 0.05);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: left;
            margin-bottom: 2rem;
        }
        .mission-analysis h3 { 
            font-family: var(--font-title); 
            color: var(--neon-pink); 
            margin-top: 0; 
            font-size: 1rem; 
            letter-spacing: 1px; 
            margin-bottom: 10px;
        }

        /* --- Charts --- */
        .chart-container { margin: 2rem 0; width: 100%; height: 160px; display: flex; align-items: flex-end; justify-content: center; gap: 20px; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; }
        .chart-bar-group { display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; width: 40px; }
        .chart-bar { width: 100%; background: var(--neon-cyan); border-radius: 4px; transition: height 1s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .chart-label { font-family: var(--font-body); font-size: 0.7rem; color: #888; margin-top: 8px; }
        .chart-val { font-family: var(--font-title); font-size: 0.7rem; font-weight: bold; margin-bottom: 5px; color: white; }

        /* --- Animations --- */
        @keyframes pulse { 0% { opacity: 1; text-shadow: 0 0 10px var(--neon-cyan); } 50% { opacity: 0.8; text-shadow: 0 0 20px var(--neon-cyan); } 100% { opacity: 1; text-shadow: 0 0 10px var(--neon-cyan); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        
        #confetti-canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 999; }
        
        @media (max-width: 768px) {
            .options-grid { grid-template-columns: 1fr; }
            .card { width: 95%; padding: 1.5rem; }
            .difficulty-grid { grid-template-columns: 1fr; gap: 10px; }
            #start-screen h1 { font-size: 2rem; }
            .btn { width: 100%; margin-bottom: 10px; }
            .chart-container { gap: 10px; }
            #freeze-correct-text { font-size: 0.8rem; }
            .freeze-msg { font-size: 1.8rem; }
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>

    <!-- Audio & Volume Controls -->
    <div id="audio-controls">
        <button id="mute-btn">üîä</button>
        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5">
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="full-screen flex-center column">
        <h1 class="title-font">IT GOVERNANCE<br>& COMPLIANCE</h1>
        <h2 class="title-font">The Directors' Cut</h2>
        <!-- UPDATED: Button now directs to How-To screen via JS -->
        <button id="start-btn" class="btn">BEGIN CAREER</button>
    </div>

    <!-- Difficulty Screen (Moved to after Onboarding in flow) -->
    <div id="difficulty-screen" class="full-screen flex-center column hidden">
        <h2 class="title-font text-white" style="margin-bottom: 1rem; font-size: 1.5rem;">Select Your Role</h2>
        <div class="card" style="background: transparent; border: none; box-shadow: none;">
            <!-- UPDATED: Buttons now call startGame directly -->
            <div class="difficulty-grid">
                <div class="diff-btn" onclick="game.startGame('easy')">
                    <span class="diff-title text-yellow">Junior Analyst</span>
                    <span class="diff-meta">EASY</span>
                    <span class="diff-hearts">6 Hearts</span>
                </div>
                <div class="diff-btn" onclick="game.startGame('medium')">
                    <span class="diff-title text-yellow">IT Project Lead</span>
                    <span class="diff-meta">MEDIUM</span>
                    <span class="diff-hearts">5 Hearts</span>
                </div>
                <div class="diff-btn" onclick="game.startGame('hard')">
                    <span class="diff-title text-yellow">Chief Digital Officer</span>
                    <span class="diff-meta">HARD</span>
                    <span class="diff-hearts">4 Hearts</span>
                </div>
                <div class="diff-btn" onclick="game.startGame('expert')">
                    <span class="diff-title text-yellow">Prof. Dr. MDBM Director</span>
                    <span class="diff-meta">EXPERT</span>
                    <span class="diff-hearts">3 Hearts</span>
                </div>
            </div>
            
            <!-- NEW BACK BUTTON -->
            <div style="margin-top: 2rem;">
                <button class="btn btn-dark" onclick="game.showScreen('howto-screen')">BACK TO ONBOARDING</button>
            </div>
        </div>
    </div>

    <!-- Onboarding / How To Play (Now 2nd screen in flow) -->
    <div id="howto-screen" class="full-screen flex-center column hidden">
        <div class="card">
            <h2 class="title-font text-cyan center" style="margin-bottom: 1rem;">ONBOARDING</h2>
            
            <p style="color: #ffffff; font-family: var(--font-body); margin-bottom: 20px; line-height: 1.5; text-align: center; font-size: 0.95rem;">
                Welcome to The Directors' Cut! This game is the final assessment project for the Digital Management module. It tests your ability to apply IT Governance and Compliance theories under pressure. Your goal is to reach 100% project completion before your competitors (Audit, Threats, and Legacy Systems) overtake your infrastructure.
            </p>

            <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 1.5rem; text-align: left; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Item 1: Mechanics -->
                <div style="display: flex; align-items: start;">
                    <div style="min-width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, #00f3ff, #0055ff); margin-right:15px; box-shadow: 0 0 10px var(--neon-cyan);"></div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.4;">Answer correctly to move your bar forward.</p>
                </div>
                <!-- Item 2: Competitors (UPDATED COLOR & TEXT) -->
                <div style="display: flex; align-items: start;">
                    <div style="min-width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ffaa00; background: rgba(255, 170, 0, 0.2); box-shadow: 0 0 10px #ffaa00; margin-right:15px;"></div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.4;">Competitors race automatically. If they finish first, <span class="text-pink" style="font-weight: bold;">YOU LOSE</span>.</p>
                </div>
                <!-- Item 3: Green Orbs -->
                <div style="display: flex; align-items: start;">
                    <div style="min-width: 30px; height: 30px; border-radius: 50%; background: rgba(0, 255, 102, 0.2); border: 2px solid white; box-shadow: 0 0 10px var(--neon-green); margin-right:15px; display: flex; align-items: center; justify-content: center;">
                        <div style="width: 60%; height: 60%; background: var(--neon-green); border-radius: 50%;"></div>
                    </div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.4;">Green Orbs are <span class="text-cyan">Patches</span>. They remove 2 wrong answers.</p>
                </div>
                <!-- Item 4: Red Orbs (NEW) -->
                <div style="display: flex; align-items: start;">
                    <div style="min-width: 30px; height: 30px; border-radius: 50%; background: rgba(255, 0, 85, 0.2); border: 2px solid #ff99bb; box-shadow: 0 0 10px var(--neon-pink); margin-right:15px; display: flex; align-items: center; justify-content: center;">
                        <div style="width: 60%; height: 60%; background: var(--neon-pink); border-radius: 50%;"></div>
                    </div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.4;">Red Orbs = <span class="text-pink">Malware</span>. If clicked: System Freeze + Life Lost. AVOID THEM!</p>
                </div>
                 <!-- Item 5: Grey Orbs -->
                <div style="display: flex; align-items: start;">
                    <div style="min-width: 30px; height: 30px; border-radius: 50%; background: rgba(100, 100, 100, 0.2); border: 2px solid #aaa; margin-right:15px; display: flex; align-items: center; justify-content: center;">
                        <div style="width: 60%; height: 60%; background: #666; border-radius: 50%;"></div>
                    </div>
                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.4;">Grey Orbs are Decoys. Ignore them!</p>
                </div>
            </div>

            <!-- New Difficulty Warning -->
            <p style="color: #ffe600; font-size: 0.85rem; margin-top: 1.5rem; margin-bottom: 0.5rem; opacity: 0.9;">
                ‚ö† Higher Difficulty = Faster Competitors, Fewer Lives, and Harder Questions.
            </p>

            <!-- MANDATORY CHECKBOX -->
            <div id="onboarding-consent" style="margin: 1rem 0; display: flex; align-items: center; justify-content: center; gap: 12px; background: rgba(255, 0, 85, 0.1); padding: 10px; border-radius: 10px; border: 1px solid rgba(255, 0, 85, 0.3);">
                <input type="checkbox" id="consent-checkbox" style="width: 22px; height: 22px; accent-color: var(--neon-pink); cursor: pointer; filter: drop-shadow(0 0 5px var(--neon-pink));">
                <label for="consent-checkbox" style="font-size: 0.85rem; color: #eee; cursor: pointer; text-align: left;">I have read the onboarding and I understand how to play.</label>
            </div>

            <!-- Updated Buttons -->
            <div style="text-align: center; margin-top: 1.5rem; display: flex; justify-content: center; gap: 15px;">
                <button class="btn btn-dark" onclick="game.showScreen('start-screen')">BACK</button>
                <button id="choose-role-btn" class="btn btn-cyan" onclick="game.showScreen('difficulty-screen')" disabled>CHOOSE ROLE</button>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="hidden">
        <!-- HUD -->
        <div class="hud-top">
            <div class="hearts-container" id="hearts-display">
                <!-- Hearts injected by JS -->
            </div>
            <div id="role-display">JUNIOR ANALYST</div>
        </div>

        <!-- Track -->
        <div class="track-container">
            <div class="lane player"><div class="bar bar-player" id="bar-player" style="width: 0%">YOU</div></div>
            <div class="lane"><div class="bar bar-bot-1" id="bar-bot-0" style="width: 0%">External Audit</div></div>
            <div class="lane"><div class="bar bar-bot-2" id="bar-bot-1" style="width: 0%">Cyber Threats</div></div>
            <div class="lane"><div class="bar bar-bot-3" id="bar-bot-2" style="width: 0%">Legacy Systems</div></div>
            
            <!-- Orbs fall here -->
            <div id="orb-layer"></div>
        </div>

        <!-- Quiz -->
        <div id="quiz-container">
            <div id="question-text" class="question-text">Loading...</div>
            <div id="options-grid" class="options-grid">
                <!-- Options injected by JS -->
            </div>
            
            <!-- Freeze Overlay -->
            <div id="freeze-overlay" class="overlay hidden">
                <div class="freeze-msg">SYSTEM FREEZE</div>
                <div class="text-white title-font" style="font-size: 3rem;" id="freeze-timer">3</div>
                <div class="correct-answer-display">
                    <div id="freeze-label">The correct answer was:</div>
                    <div id="freeze-correct-text">Option</div>
                </div>
            </div>
        </div>
    </div>

    <!-- End Screen (Win/Lose) -->
    <div id="end-screen" class="full-screen flex-center column hidden">
        <canvas id="confetti-canvas"></canvas>
        <div class="card" style="z-index: 50; max-height: 95vh; overflow-y: auto; width: 800px;">
            <h1 id="end-title" class="title-font">SYSTEM BREACH</h1>
            <p id="end-message" style="margin-bottom: 2rem; color: #ccc;">The competitors overtook your infrastructure. Audit failed.</p>

            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 2rem;">
                <button class="btn btn-white" style="border-radius: 30px;" onclick="game.resetGame()">Try Again</button>
                <button class="btn btn-dark" style="border-radius: 30px;" onclick="game.resetGame()">Change Difficulty</button>
                <button id="pdf-btn" class="btn btn-cyan" style="border-radius: 30px;" onclick="game.generatePDF()">Download Report</button>
            </div>

            <!-- Learning Suggestions (Lose only) -->
            <div id="learning-box" class="mission-analysis hidden">
                <h3>MISSION ANALYSIS</h3>
                <p id="adaptive-msg" style="font-size: 0.9rem; color: #ccc; margin-bottom: 15px;">Keep practicing! You're building a strong foundation.</p>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                    <div style="font-size: 0.8rem; color: var(--neon-cyan); margin-bottom: 5px; font-weight: bold;">REVIEW THESE TOPICS:</div>
                    <div id="topic-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.85rem; color: white;"></div>
                </div>
            </div>

            <!-- Stats Chart -->
            <div class="chart-container" id="stats-chart">
                <!-- Bars injected by JS -->
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS & DATA ---
        const CONFIG = {
            hearts: { 'easy': 6, 'medium': 5, 'hard': 4, 'expert': 3 },
            botSpeed: { 'easy': 0.015, 'medium': 0.020, 'hard': 0.027, 'expert': 0.042 },  //{ 'easy': 0.015, 'medium': 0.03, 'hard': 0.05, 'expert': 0.07 }
            titles: { 'easy': 'Junior Analyst', 'medium': 'IT Project Lead', 'hard': 'Chief Digital Officer', 'expert': 'Prof. Dr. MDBM Director' }
        };

        const QUESTIONS = [
            // --- EASY LEVEL (20 Questions) ---
            { level: 'easy', q: "What is the main purpose of IT governance?", options: ["To align IT with business goals", "To write software code", "To replace management", "To control employees"], correct: 0 },
            { level: 'easy', q: "Which organization publishes the COBIT framework?", options: ["ISACA", "ISO", "IEEE", "PMI"], correct: 0 },
            { level: 'easy', q: "What does IT stand for?", options: ["Information Technology", "Internet Tools", "Integrated Technology", "Information Transfer"], correct: 0 },
            { level: 'easy', q: "What is the focus of IT governance?", options: ["Value, risk, and alignment", "Hardware repair", "Employee salaries", "Marketing campaigns"], correct: 0 },
            { level: 'easy', q: "Which COBIT version is the latest?", options: ["COBIT 2019", "COBIT 4.1", "COBIT 5", "COBIT 2022"], correct: 0 },
            { level: 'easy', q: "Who is responsible for IT governance in an organization?", options: ["Board and executive management", "Only IT staff", "External auditors", "Customers"], correct: 0 },
            { level: 'easy', q: "What does compliance mainly ensure?", options: ["Following laws and regulations", "Increasing profits", "Faster software", "Lower salaries"], correct: 0 },
            { level: 'easy', q: "What is a mission statement?", options: ["Reason why an organization exists", "Daily task list", "Financial report", "IT policy"], correct: 0 },
            { level: 'easy', q: "What does I&T mean in COBIT?", options: ["Information and Technology", "Internet and Tools", "Infrastructure and Technology", "Innovation and Testing"], correct: 0 },
            { level: 'easy', q: "What is one key objective of IT governance?", options: ["Deliver value to stakeholders", "Eliminate IT departments", "Reduce communication", "Increase bureaucracy"], correct: 0 },
            { level: 'easy', q: "Which area does ITIL mainly address?", options: ["IT Service Management", "Financial auditing", "Software development", "Marketing strategy"], correct: 0 },
            { level: 'easy', q: "What is governance?", options: ["System for decision-making and control", "Daily IT operations", "Software testing", "Programming"], correct: 0 },
            { level: 'easy', q: "What does ROI measure?", options: ["Return on investment", "Risk of innovation", "Rate of infrastructure", "Resources of IT"], correct: 0 },
            { level: 'easy', q: "What is a stakeholder?", options: ["Anyone affected by organizational decisions", "Only shareholders", "Only managers", "Only customers"], correct: 0 },
            { level: 'easy', q: "What does COBIT help organizations do?", options: ["Govern and manage IT effectively", "Develop mobile apps", "Hire IT staff", "Fix hardware"], correct: 0 },
            { level: 'easy', q: "What is one benefit of IT investment?", options: ["Improved efficiency", "More paperwork", "Higher risk", "Less automation"], correct: 0 },
            { level: 'easy', q: "What is an IT strategy aligned with?", options: ["Business strategy", "Marketing budget", "Employee bonuses", "Office layout"], correct: 0 },
            { level: 'easy', q: "Which is a tangible IT benefit?", options: ["Cost reduction", "Employee motivation", "Brand image", "Culture change"], correct: 0 },
            { level: 'easy', q: "What is the first step in IT governance implementation?", options: ["Assessment of current IT", "Hiring consultants", "Buying tools", "Writing policies"], correct: 0 },
            { level: 'easy', q: "What does governance aim to protect?", options: ["Stakeholder interests", "Only profits", "Only data", "Only IT staff"], correct: 0 },


           
            // --- MEDIUM LEVEL (20 Questions) ---
            { level: 'medium', q: "What are the three main outcomes of enterprise IT governance?", options: ["Value delivery, risk optimization, resource optimization", "Speed, cost, innovation", "Planning, coding, testing", "Security, hardware, software"], correct: 0 },
            { level: 'medium', q: "What is the purpose of the COBIT goals cascade?", options: ["Translate stakeholder needs into IT objectives", "Replace ITIL", "Automate processes", "Reduce costs"], correct: 0 },
            { level: 'medium', q: "What distinguishes governance from management in COBIT?", options: ["Governance sets direction, management executes", "Governance executes tasks", "They are the same", "Management audits governance"], correct: 0 },
            { level: 'medium', q: "Which factor strongly drives IT governance?", options: ["Business needs", "Office size", "Employee age", "Brand colors"], correct: 0 },
            { level: 'medium', q: "What is a key role of compliance in IT?", options: ["Ensuring regulatory adherence", "Increasing innovation", "Managing projects", "Improving UX"], correct: 0 },
            { level: 'medium', q: "What does an IT assessment mainly establish?", options: ["A baseline of current IT operations", "Future profits", "New software", "Employee rankings"], correct: 0 },
            { level: 'medium', q: "Which assessment method allows group interaction?", options: ["Workshop", "Survey", "Audit", "Benchmarking"], correct: 0 },
            { level: 'medium', q: "What is a focus group characterized by?", options: ["Discussion on a specific topic", "Open-ended debate", "Individual interviews", "Automated surveys"], correct: 0 },
            { level: 'medium', q: "What is a mission statement mainly focused on?", options: ["Actions and purpose", "Future vision only", "Financial targets", "IT tools"], correct: 0 },
            { level: 'medium', q: "What does strategic alignment ensure?", options: ["IT supports business goals", "IT replaces business", "Business controls IT daily", "No governance needed"], correct: 0 },
            { level: 'medium', q: "Which is a hard governance area?", options: ["Processes", "Culture", "Leadership style", "Behavior"], correct: 0 },
            { level: 'medium', q: "Which document expresses verifiable IT service requirements?", options: ["ISO/IEC 20000", "ITIL", "COBIT", "CMMI"], correct: 0 },
            { level: 'medium', q: "What is a design factor in COBIT?", options: ["Enterprise strategy", "Office location", "Company logo", "Dress code"], correct: 0 },
            { level: 'medium', q: "What does risk optimization aim to do?", options: ["Preserve business value", "Eliminate all risks", "Ignore threats", "Reduce innovation"], correct: 0 },
            { level: 'medium', q: "Who benefits from COBIT guidance?", options: ["Board, management, and IT leaders", "Only auditors", "Only developers", "Only customers"], correct: 0 },
            { level: 'medium', q: "What is the role of KPIs in IT governance?", options: ["Measure performance", "Increase workload", "Control salaries", "Replace audits"], correct: 0 },
            { level: 'medium', q: "What does resource optimization include?", options: ["People, infrastructure, and data", "Only hardware", "Only software", "Only budgets"], correct: 0 },
            { level: 'medium', q: "What is a key principle of COBIT 2019?", options: ["Holistic approach", "Technical focus only", "IT isolation", "Fixed governance"], correct: 0 },
            { level: 'medium', q: "What does EGIT stand for?", options: ["Enterprise Governance of Information and Technology", "Electronic Governance IT", "Enterprise Global IT", "Executive Governance IT"], correct: 0 },
            { level: 'medium', q: "Why is IT governance becoming more important?", options: ["Increased digital dependence", "Lower IT costs", "Fewer regulations", "Less technology"], correct: 0 },




            // --- HARD LEVEL (20 Questions) ---
            { level: 'hard', q: "Why does COBIT separate governance and management?", options: ["They serve different purposes and responsibilities", "To reduce workload", "To simplify audits", "To eliminate management"], correct: 0 },
            { level: 'hard', q: "Which COBIT principle ensures adaptability?", options: ["Dynamic governance system", "Holistic approach", "End-to-end coverage", "Stakeholder value"], correct: 0 },
            { level: 'hard', q: "What does the IT governance life cycle emphasize?", options: ["Continuous improvement", "One-time implementation", "Tool acquisition", "Process elimination"], correct: 0 },
            { level: 'hard', q: "Which component replaced COBIT 5 enablers?", options: ["Governance system components", "Control objectives", "IT domains", "Audit metrics"], correct: 0 },
            { level: 'hard', q: "What does benefit realization focus on?", options: ["Maximizing IT-enabled value", "Reducing IT staff", "Cutting budgets", "Compliance only"], correct: 0 },
            { level: 'hard', q: "What is the main goal of the goals cascade?", options: ["Align enterprise goals with IT objectives", "Automate governance", "Replace strategy", "Increase compliance"], correct: 0 },
            { level: 'hard', q: "What does COBIT NOT do?", options: ["Prescribe specific IT solutions", "Support governance", "Provide frameworks", "Align IT and business"], correct: 0 },
            { level: 'hard', q: "Which role primarily executes governance decisions?", options: ["Executive management", "Board only", "Auditors", "Customers"], correct: 0 },
            { level: 'hard', q: "What does tailoring governance mean?", options: ["Adapting COBIT to enterprise context", "Strictly following the framework", "Ignoring standards", "Removing controls"], correct: 0 },
            { level: 'hard', q: "What does performance management in COBIT use?", options: ["Capability and maturity levels", "Binary checks", "Budget metrics", "HR evaluations"], correct: 0 },
            { level: 'hard', q: "Why is data considered a key resource?", options: ["It enables value creation", "It replaces people", "It reduces governance", "It eliminates risk"], correct: 0 },
            { level: 'hard', q: "What does end-to-end governance imply?", options: ["Coverage of entire enterprise", "IT-only focus", "Department-level control", "Outsourced governance"], correct: 0 },
            { level: 'hard', q: "Which principle emphasizes stakeholder balance?", options: ["Provide stakeholder value", "Dynamic governance", "Holistic approach", "Open framework"], correct: 0 },
            { level: 'hard', q: "What is the relationship between risk and value?", options: ["Risk optimization preserves value", "Risk eliminates value", "Value removes risk", "They are unrelated"], correct: 0 },
            { level: 'hard', q: "What is a key challenge of EGIT?", options: ["Complexity and context dependency", "Lack of standards", "Too much automation", "No stakeholder involvement"], correct: 0 },
            { level: 'hard', q: "What is a governance framework principle?", options: ["Open and flexible", "Fixed and rigid", "IT-specific", "Tool-driven"], correct: 0 },
            { level: 'hard', q: "What does strategic alignment prevent?", options: ["IT-business misalignment", "Innovation", "Compliance", "Digital growth"], correct: 0 },
            { level: 'hard', q: "Why are audits important in IT governance?", options: ["Monitor performance and compliance", "Replace management", "Increase costs", "Eliminate risks"], correct: 0 },
            { level: 'hard', q: "What is the focus of ISO/IEC 38500?", options: ["Corporate governance of IT", "IT service delivery", "Software quality", "Security controls"], correct: 0 },
            { level: 'hard', q: "What does COBIT emphasize over tools?", options: ["Decision-making structures", "Technology choice", "Programming languages", "Cloud providers"], correct: 0 },


            // --- EXPERT LEVEL (20 Questions) ---
            { level: 'expert', q: "Why is EGIT considered context-dependent?", options: ["Each enterprise has unique drivers and risks", "COBIT is incomplete", "IT is optional", "Standards are outdated"], correct: 0 },
            { level: 'expert', q: "How does COBIT support value creation?", options: ["Balancing benefits, risk, and resources", "Maximizing IT spending", "Reducing governance", "Automating decisions"], correct: 0 },
            { level: 'expert', q: "What is the strategic role of the board in IT governance?", options: ["Setting direction and monitoring performance", "Managing daily IT tasks", "Developing software", "Running audits"], correct: 0 },
            { level: 'expert', q: "Why is separating governance and management critical?", options: ["To ensure accountability and clarity", "To reduce documentation", "To avoid audits", "To increase hierarchy"], correct: 0 },
            { level: 'expert', q: "What risk does poor EGIT increase?", options: ["Failure to realize business value", "Higher innovation", "Faster delivery", "Better alignment"], correct: 0 },
            { level: 'expert', q: "What does a holistic approach require?", options: ["Integration of all governance components", "Focus on technology only", "Strict procedures", "External control"], correct: 0 },
            { level: 'expert', q: "How does COBIT handle technological change?", options: ["Through dynamic governance design", "By freezing policies", "Ignoring innovation", "Delegating to vendors"], correct: 0 },
            { level: 'expert', q: "What does tailoring governance improve?", options: ["Effectiveness and relevance", "Complexity", "Compliance costs", "IT isolation"], correct: 0 },
            { level: 'expert', q: "Why is stakeholder value central in COBIT?", options: ["Organizations exist to serve stakeholders", "Stakeholders manage IT", "Compliance requires it", "Audits demand it"], correct: 0 },
            { level: 'expert', q: "What role do design factors play?", options: ["Customize governance systems", "Replace frameworks", "Define technologies", "Eliminate standards"], correct: 0 },
            { level: 'expert', q: "What is the biggest misconception about COBIT?", options: ["It prescribes IT decisions", "It supports governance", "It aligns IT and business", "It is flexible"], correct: 0 },
            { level: 'expert', q: "How does EGIT support digital transformation?", options: ["Ensuring value and risk balance", "Reducing IT usage", "Removing governance", "Limiting innovation"], correct: 0 },
            { level: 'expert', q: "What does capability maturity indicate?", options: ["Process effectiveness level", "Budget size", "Tool complexity", "Staff experience"], correct: 0 },
            { level: 'expert', q: "Why must governance be enterprise-wide?", options: ["IT impacts all business areas", "IT is centralized", "Audits require it", "Standards enforce it"], correct: 0 },
            { level: 'expert', q: "What is the main governance challenge in large enterprises?", options: ["Complex coordination and alignment", "Lack of IT tools", "No regulations", "Too few stakeholders"], correct: 0 },
            { level: 'expert', q: "What enables sustainable IT value?", options: ["Continuous governance improvement", "One-time audits", "Fixed strategies", "Vendor control"], correct: 0 },
            { level: 'expert', q: "Why is culture included in governance components?", options: ["Behavior influences governance success", "It replaces processes", "It eliminates risk", "It reduces controls"], correct: 0 },
            { level: 'expert', q: "What does performance monitoring prevent?", options: ["Deviation from strategic objectives", "Innovation", "Digital growth", "Compliance"], correct: 0 },
            { level: 'expert', q: "Why does COBIT avoid technical prescriptions?", options: ["To remain universally applicable", "To reduce scope", "To limit responsibility", "To focus on audits"], correct: 0 },
            { level: 'expert', q: "What is the ultimate goal of IT governance?", options: ["Sustainable business value from I&T", "Perfect compliance", "Zero risk", "Maximum automation"], correct: 0 }


        ];

        const LEARNING_TOPICS = ["IT Governance", "Compliance Frameworks", "Internal Controls", "Cybersecurity Basics", "Risk Management", "Audit & Regulation"];

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const masterGain = audioCtx.createGain();
        masterGain.connect(audioCtx.destination);
        masterGain.gain.value = 0.5;

        class AudioEngine {
            constructor() {
                this.muted = false;
                this.isPlaying = false;
                this.loopId = null;
                this.nextNoteTime = 0;
                this.tempo = 110;
                this.beat = 0;
            }

            toggleMute() {
                this.muted = !this.muted;
                masterGain.gain.setTargetAtTime(this.muted ? 0 : document.getElementById('volume-slider').value, audioCtx.currentTime, 0.1);
                return this.muted;
            }

            setVolume(val) {
                if(!this.muted) masterGain.gain.setTargetAtTime(val, audioCtx.currentTime, 0.1);
            }

            playTone(freq, type, duration, vol = 0.1) {
                if (this.muted) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                
                osc.connect(gain);
                gain.connect(masterGain);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            }

            playSFX(type) {
                if (this.muted) return;
                const now = audioCtx.currentTime;
                if (type === 'click') this.playTone(800, 'sine', 0.1, 0.05);
                if (type === 'win') {
                    [523, 659, 783, 1046].forEach((f, i) => setTimeout(() => this.playTone(f, 'triangle', 0.4, 0.2), i * 100));
                }
                if (type === 'error') {
                     this.playTone(150, 'sawtooth', 0.3, 0.2);
                     setTimeout(() => this.playTone(100, 'sawtooth', 0.3, 0.2), 150);
                }
                if (type === 'powerup') this.playTone(1200, 'sine', 0.3, 0.2);
                if (type === 'damage') {
                    this.playTone(100, 'square', 0.3, 0.2); 
                    this.playTone(80, 'square', 0.3, 0.2);
                }
            }

            startMusic() {
                if (this.isPlaying) return;
                this.isPlaying = true;
                this.nextNoteTime = audioCtx.currentTime;
                this.scheduler();
            }

            stopMusic() {
                this.isPlaying = false;
                clearTimeout(this.loopId);
            }

            scheduler() {
                while (this.nextNoteTime < audioCtx.currentTime + 0.1) {
                    this.playBeat(this.beat, this.nextNoteTime);
                    this.nextNoteTime += 60.0 / this.tempo / 4; // 16th notes
                    this.beat = (this.beat + 1) % 16;
                }
                if(this.isPlaying) this.loopId = setTimeout(() => this.scheduler(), 25);
            }

            playBeat(beat, time) {
                if (this.muted) return;
                // Kick (4 on floor)
                if (beat % 4 === 0) {
                    const osc = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    osc.connect(g); g.connect(masterGain);
                    osc.frequency.setValueAtTime(150, time);
                    osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
                    g.gain.setValueAtTime(0.4, time);
                    g.gain.exponentialRampToValueAtTime(0.01, time + 0.5);
                    osc.start(time); osc.stop(time + 0.5);
                }
                // Bass (Offbeat)
                if (beat % 4 === 2) {
                    const osc = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    osc.type = 'sawtooth';
                    osc.connect(g); g.connect(masterGain);
                    osc.frequency.setValueAtTime(65, time);
                    g.gain.setValueAtTime(0.15, time);
                    g.gain.linearRampToValueAtTime(0, time + 0.2);
                    osc.start(time); osc.stop(time + 0.2);
                }
                // HiHat (16ths)
                if (beat % 2 === 0) {
                    // Simple noise simulation using high freq square
                    const osc = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(8000, time);
                    osc.connect(g); g.connect(masterGain);
                    g.gain.setValueAtTime(0.05, time);
                    g.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
                    osc.start(time); osc.stop(time + 0.05);
                }
            }
        }
        const audio = new AudioEngine();

        // --- GAME LOGIC ---
        class Game {
            constructor() {
                this.difficulty = 'medium';
                this.screen = 'start-screen';
                this.stats = { total: 0, correct: 0, wrong: 0, jokers: 0 };
                this.lives = 3;
                this.progress = { player: 0, bots: [0, 0, 0] };
                this.isPlaying = false;
                this.frozen = false;
                this.orbs = [];
                this.questions = [];
                this.history = []; // Track Q&A for PDF
                this.currentQ = null;
                this.removedOptions = [];
                this.animationFrame = null;
                this.lastTime = 0;
            }

            init() {
                document.getElementById('start-btn').onclick = () => {
                    audioCtx.resume();
                    this.showScreen('howto-screen');
                };
                document.getElementById('volume-slider').oninput = (e) => audio.setVolume(e.target.value);
                document.getElementById('mute-btn').onclick = (e) => {
                   const muted = audio.toggleMute();
                   e.target.innerText = muted ? 'üîá' : 'üîä';
                };

                // ONBOARDING CONSENT LOGIC
                const consentCheckbox = document.getElementById('consent-checkbox');
                const chooseRoleBtn = document.getElementById('choose-role-btn');
                consentCheckbox.onchange = (e) => {
                    chooseRoleBtn.disabled = !e.target.checked;
                };
            }

            showScreen(id) {
                document.body.classList.remove('defeat-mode', 'victory-mode');
                document.querySelectorAll('div[id$="-screen"]').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(id);
                if (target) target.classList.remove('hidden');
                audio.playSFX('click');
            }

            resetGame() {
                this.orbs.forEach(o => o.el.remove());
                this.orbs = [];
                this.stats = { total: 0, correct: 0, wrong: 0, jokers: 0 };
                document.body.classList.remove('defeat-mode', 'victory-mode');
                stopConfetti();
                
                // Reset onboarding consent on game reset
                const consentCheckbox = document.getElementById('consent-checkbox');
                const chooseRoleBtn = document.getElementById('choose-role-btn');
                if (consentCheckbox) consentCheckbox.checked = false;
                if (chooseRoleBtn) chooseRoleBtn.disabled = true;

                this.showScreen('difficulty-screen');
            }

            startGame(level = null) {
                if (level) {
                    this.difficulty = level;
                }

                this.lives = CONFIG.hearts[this.difficulty];
                this.progress = { player: 0, bots: [0, 0, 0] };
                this.orbs = [];
                this.frozen = false;
                this.removedOptions = [];
                this.history = [];
                document.body.classList.remove('defeat-mode', 'victory-mode');
                
                let pool = QUESTIONS.filter(q => q.level === this.difficulty);
                if (pool.length === 0) pool = QUESTIONS.filter(q => q.level === 'easy'); 
                this.questions = this.shuffle([...pool]);
                
                this.renderHearts();
                this.renderRole();
                this.loadNextQuestion();
                this.showScreen('game-screen');
                
                audio.startMusic();
                this.isPlaying = true;
                this.lastTime = performance.now();
                this.animationFrame = requestAnimationFrame(t => this.loop(t));
                
                this.orbSpawner = setInterval(() => this.spawnOrb(), 2500); 
            }

            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            renderHearts() {
                const container = document.getElementById('hearts-display');
                container.innerHTML = '';
                for(let i=0; i<CONFIG.hearts[this.difficulty]; i++) {
                    const h = document.createElement('div');
                    h.className = `heart ${i < this.lives ? '' : 'lost'}`;
                    container.appendChild(h);
                }
            }

            renderRole() {
                document.getElementById('role-display').innerText = CONFIG.titles[this.difficulty];
            }

            loadNextQuestion() {
                if(this.questions.length === 0) {
                    let pool = QUESTIONS.filter(q => q.level === this.difficulty);
                    if (pool.length === 0) pool = QUESTIONS.filter(q => q.level === 'easy');
                    this.questions = this.shuffle([...pool]);
                }
                
                const qData = this.questions.pop();
                const indices = [0, 1, 2, 3];
                this.shuffle(indices);
                
                this.currentQ = {
                    text: qData.q,
                    options: indices.map(i => qData.options[i]),
                    correctIndex: indices.indexOf(qData.correct),
                    originalData: qData
                };

                this.removedOptions = [];
                this.renderQuestion();
            }

            renderQuestion() {
                document.getElementById('question-text').innerText = this.currentQ.text;
                const grid = document.getElementById('options-grid');
                grid.innerHTML = '';
                
                this.currentQ.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerText = opt;
                    if(this.removedOptions.includes(idx)) {
                        btn.classList.add('removed');
                        btn.disabled = true;
                    }
                    btn.onclick = () => this.handleAnswer(idx);
                    grid.appendChild(btn);
                });

                document.getElementById('quiz-container').classList.remove('frozen');
                document.getElementById('freeze-overlay').classList.add('hidden');
            }

            handleAnswer(idx) {
                if(this.frozen) return;

                this.stats.total++;
                const isCorrect = (idx === this.currentQ.correctIndex);
                
                this.history.push({
                    q: this.currentQ.text,
                    status: isCorrect ? 'CORRECT' : 'WRONG'
                });

                if (isCorrect) {
                    this.stats.correct++;
                    audio.playSFX('powerup');
                    this.progress.player = Math.min(100, this.progress.player + 10);
                    setTimeout(() => this.loadNextQuestion(), 400);
                } else {
                    this.stats.wrong++;
                    this.takeDamage();
                    audio.playSFX('error');
                    this.freezeGame();
                }
            }

            freezeGame(penaltyType = null) {
                this.frozen = true;
                const overlay = document.getElementById('freeze-overlay');
                const timerEl = document.getElementById('freeze-timer');
                const correctText = document.getElementById('freeze-correct-text');
                const label = document.getElementById('freeze-label');
                
                overlay.classList.remove('hidden');
                document.getElementById('quiz-container').classList.add('frozen');

                if (penaltyType === 'red_orb') {
                    label.innerText = "SECURITY BREACH DETECTED";
                    correctText.innerText = "System Halted";
                    correctText.style.color = "var(--neon-pink)";
                } else {
                    label.innerText = "The correct answer was:";
                    correctText.innerText = this.currentQ.options[this.currentQ.correctIndex];
                    correctText.style.color = "var(--neon-cyan)";
                }
                
                let time = 3;
                timerEl.innerText = time;
                
                const interval = setInterval(() => {
                    time--;
                    timerEl.innerText = time;
                    if(time <= 0) {
                        clearInterval(interval);
                        this.frozen = false;
                        this.loadNextQuestion();
                    }
                }, 1000);
            }

            takeDamage() {
                this.lives--;
                this.renderHearts();
                if(this.lives <= 0) this.endGame(false);
            }

            spawnOrb() {
                if (!this.isPlaying || this.frozen) return;
                
                const typeRand = Math.random();
                let type = 'grey'; 
                if (typeRand < 0.17) type = 'green'; 
                else if (typeRand < 0.5) type = 'red'; 

                const orb = document.createElement('div');
                orb.className = `orb ${type}`;
                orb.innerHTML = '<div class="orb-inner"></div>';
                
                const x = Math.random() * 80 + 10;
                orb.style.left = x + '%';
                orb.style.top = '-60px';
                
                orb.onmousedown = (e) => {
                    e.stopPropagation();
                    this.handleOrbClick(type, orb);
                };
                orb.ontouchstart = (e) => {
                    e.stopPropagation();
                    this.handleOrbClick(type, orb);
                };

                document.getElementById('orb-layer').appendChild(orb);
                
                let speed = (Math.random() * 1.5 + 1.5);
                if (Math.random() < 0.2) speed += 2.0;

                this.orbs.push({
                    el: orb,
                    y: -60,
                    speed: speed * (window.innerHeight / 800)
                });
            }

            handleOrbClick(type, el) {
                el.remove();
                this.orbs = this.orbs.filter(o => o.el !== el);

                if (type === 'green') {
                    this.stats.jokers++;
                    audio.playSFX('powerup');
                    
                    const wrongIndices = [0,1,2,3].filter(i => i !== this.currentQ.correctIndex);
                    for (let i = wrongIndices.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [wrongIndices[i], wrongIndices[j]] = [wrongIndices[j], wrongIndices[i]];
                    }
                    
                    const toRemove = wrongIndices.slice(0, 2);
                    this.removedOptions = [...new Set([...this.removedOptions, ...toRemove])];
                    this.renderQuestion(); 
                    
                } else if (type === 'red') {
                    audio.playSFX('damage');
                    this.takeDamage();
                    this.freezeGame('red_orb'); 
                } else {
                    audio.playSFX('click');
                }
            }

            loop(timestamp) {
                if (!this.isPlaying) return;
                const dt = timestamp - this.lastTime;
                this.lastTime = timestamp;

                const botSpeed = CONFIG.botSpeed[this.difficulty] * (dt / 16);
                this.progress.bots = this.progress.bots.map(p => Math.min(100, p + botSpeed * (0.8 + Math.random()*0.4)));

                if (!this.frozen) {
                    this.orbs.forEach(orb => {
                        orb.y += orb.speed * (dt / 16);
                        orb.el.style.transform = `translateY(${orb.y}px)`;
                    });
                    
                    const limit = document.querySelector('.track-container').offsetHeight;
                    this.orbs = this.orbs.filter(orb => {
                        if (orb.y > limit) {
                            orb.el.remove();
                            return false;
                        }
                        return true;
                    });
                }

                document.getElementById('bar-player').style.width = this.progress.player + '%';
                document.getElementById('bar-bot-0').style.width = this.progress.bots[0] + '%';
                document.getElementById('bar-bot-1').style.width = this.progress.bots[1] + '%';
                document.getElementById('bar-bot-2').style.width = this.progress.bots[2] + '%';

                if (this.progress.player >= 100) this.endGame(true);
                else if (this.progress.bots.some(p => p >= 100)) this.endGame(false);
                else this.animationFrame = requestAnimationFrame(t => this.loop(t));
            }

            endGame(win) {
                this.isPlaying = false;
                audio.stopMusic();
                if (this.orbSpawner) clearInterval(this.orbSpawner);
                cancelAnimationFrame(this.animationFrame);
                
                audio.playSFX(win ? 'win' : 'damage'); 
                
                const title = document.getElementById('end-title');
                const msg = document.getElementById('end-message');
                const pdfBtn = document.getElementById('pdf-btn');
                const learningBox = document.getElementById('learning-box');

                this.showScreen('end-screen');
                this.renderStatsChart();

                if (win) {
                    document.body.classList.remove('defeat-mode');
                    document.body.classList.add('victory-mode'); 
                    title.innerText = "COMPLIANCE SECURED";
                    title.className = "title-font text-white";
                    msg.innerText = "You successfully navigated the IT Governance landscape.";
                    pdfBtn.classList.remove('hidden');
                    learningBox.classList.add('hidden');
                    startConfetti();
                } else {
                    document.body.classList.add('defeat-mode');
                    document.body.classList.remove('victory-mode'); 
                    title.innerText = "SYSTEM BREACH";
                    title.className = "title-font text-pink";
                    msg.innerText = "The competitors overtook your infrastructure. Audit failed.";
                    pdfBtn.classList.add('hidden');
                    learningBox.classList.remove('hidden');
                    this.generateSuggestions();
                }
            }

            generateSuggestions() {
                const diffs = ['easy', 'medium', 'hard', 'expert'];
                const currIdx = diffs.indexOf(this.difficulty);
                const msgEl = document.getElementById('adaptive-msg');
                
                if (currIdx > 0) {
                    msgEl.innerText = `Consider trying '${CONFIG.titles[diffs[currIdx-1]]}' to practice.`;
                } else {
                    msgEl.innerText = "Keep practicing! You're building a strong foundation.";
                }

                const list = document.getElementById('topic-list');
                list.innerHTML = '';
                const topics = this.shuffle([...LEARNING_TOPICS]).slice(0, 3);
                topics.forEach(t => {
                    const li = document.createElement('div');
                    li.innerHTML = `<span style="color:var(--neon-pink)">‚ö†</span> ${t}`;
                    list.appendChild(li);
                });
            }

            renderStatsChart() {
                const container = document.getElementById('stats-chart');
                container.innerHTML = '';
                
                const data = [
                    { label: 'Total Qs', val: this.stats.total, color: '#ccc' },
                    { label: 'Correct', val: this.stats.correct, color: 'var(--neon-cyan)' },
                    { label: 'Wrong', val: this.stats.wrong, color: '#ff2200' },
                    { label: 'Jokers', val: this.stats.jokers, color: 'var(--neon-green)' },
                    { label: 'Hearts', val: this.lives, color: 'var(--neon-pink)' }
                ];
                
                const max = Math.max(...data.map(d => d.val), 10);
                
                data.forEach(d => {
                    const group = document.createElement('div');
                    group.className = 'chart-bar-group';
                    
                    const valDiv = document.createElement('div');
                    valDiv.className = 'chart-val';
                    valDiv.innerText = d.val;
                    
                    const bar = document.createElement('div');
                    bar.className = 'chart-bar';
                    bar.style.height = '0%'; 
                    bar.style.backgroundColor = d.color;
                    
                    const label = document.createElement('div');
                    label.className = 'chart-label';
                    label.innerText = d.label;
                    
                    group.appendChild(valDiv);
                    group.appendChild(bar);
                    group.appendChild(label);
                    container.appendChild(group);
                    
                    setTimeout(() => bar.style.height = (d.val / max * 100) + '%', 100);
                });
            }

            generatePDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();

                doc.setFillColor(5, 10, 20); 
                doc.rect(0, 0, pageWidth, pageHeight, 'F');

                doc.setLineWidth(1);
                doc.setDrawColor(0, 243, 255); 
                doc.rect(5, 5, pageWidth - 10, pageHeight - 10);
                
                doc.setLineWidth(0.5);
                doc.setDrawColor(255, 0, 85); 
                doc.rect(7, 7, pageWidth - 14, pageHeight - 14);

                doc.setFont("courier", "bold");
                doc.setFontSize(22);
                doc.setTextColor(0, 243, 255); 
                doc.text("IT GOVERNANCE REPORT", pageWidth / 2, 25, { align: "center" });

                doc.setFontSize(14);
                doc.setTextColor(255, 0, 85); 
                doc.text("/// CONFIDENTIAL ///", pageWidth / 2, 35, { align: "center" }); 

                let cursorY = 50;
                doc.setFont("courier", "normal");
                doc.setFontSize(10);
                doc.setTextColor(255, 255, 255); 

                const leftMargin = 20;

                doc.text(`IT Governance:`, leftMargin, cursorY); cursorY += 5;
                doc.text(`Director's Report`, leftMargin, cursorY); cursorY += 5;
                doc.text(`Role: ${CONFIG.titles[this.difficulty]}`, leftMargin, cursorY); cursorY += 5;
                
                const statusText = this.lives > 0 ? "COMPLIANCE SECURED (VICTORY)" : "SYSTEM BREACH (FAILURE)";
                doc.setTextColor(this.lives > 0 ? 0 : 255, this.lives > 0 ? 255 : 0, this.lives > 0 ? 102 : 85); 
                doc.text(`Status: ${statusText}`, leftMargin, cursorY); 
                cursorY += 10;

                doc.setFillColor(16, 24, 46); 
                doc.setDrawColor(0, 243, 255); 
                doc.setLineWidth(0.5);
                doc.rect(leftMargin, cursorY, pageWidth - (leftMargin * 2), 40, 'FD');

                let boxY = cursorY + 8;
                doc.setFontSize(11);
                doc.setTextColor(0, 243, 255); 
                doc.text("Performance Metrics:", leftMargin + 5, boxY);
                
                boxY += 7;
                doc.setFontSize(9);
                doc.setTextColor(255, 255, 255); 

                const qText = `- Questions Attempted: ${this.stats.total}`;
                const cText = `- Correct Answers:     ${this.stats.correct}`;
                const wText = `- Compliance Breaches: ${this.stats.wrong}`;
                const pText = `- Patches Applied:     ${this.stats.jokers}`;
                const hText = `- System Integrity:    ${this.lives}`;

                doc.text(qText, leftMargin + 10, boxY); boxY += 5;
                doc.text(cText, leftMargin + 10, boxY); boxY += 5;
                doc.text(wText, leftMargin + 10, boxY); boxY += 5;
                doc.text(pText, leftMargin + 10, boxY); boxY += 5;
                doc.text(hText, leftMargin + 10, boxY);
                
                cursorY += 50; 

                doc.setFontSize(12);
                doc.setTextColor(0, 243, 255); 
                doc.text("Session History", leftMargin, cursorY);
                cursorY += 8;

                doc.setFontSize(9);
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(0.1);
                doc.line(leftMargin, cursorY - 4, pageWidth - leftMargin, cursorY - 4);

                this.history.forEach((item, index) => {
                    if (cursorY > pageHeight - 15) return; 

                    const isPass = item.status === 'CORRECT';
                    const tag = isPass ? "[PASS]" : "[FAIL]";
                    
                    if (isPass) doc.setTextColor(0, 255, 102); 
                    else doc.setTextColor(255, 0, 85); 
                    
                    doc.text(tag, leftMargin, cursorY);

                    doc.setTextColor(255, 255, 255);
                    const textX = leftMargin + 15;
                    const maxWidth = pageWidth - textX - leftMargin;
                    
                    const wrappedText = doc.splitTextToSize(`${index + 1}. ${item.q}`, maxWidth);
                    doc.text(wrappedText, textX, cursorY);
                    
                    cursorY += (wrappedText.length * 4) + 3; 
                });

                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text("Generated by IT Governance Director's Cut System", pageWidth / 2, pageHeight - 5, { align: "center" });

                doc.save("Director_Report.pdf");
            }
        }

        let confettiAnimationId = null;
        let particles = []; 

        window.addEventListener('resize', () => {
            const canvas = document.getElementById('confetti-canvas');
            if (canvas) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
        });

        function startConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const colors = ['#9D00FF', '#FF0000', '#00F3FF', '#00FF66', '#FFE600', '#FFFFFF', '#FF00FF'];
            particles = [];
            
            for(let i=0; i<200; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    vx: Math.random() * 4 - 2,  
                    vy: Math.random() * 2 + 2,  
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 6 + 4, 
                    angle: Math.random() * 360,
                    spin: Math.random() * 4 - 2
                });
            }
            
            function animate() {
                if(document.getElementById('end-screen').classList.contains('hidden')) {
                     if (confettiAnimationId) cancelAnimationFrame(confettiAnimationId);
                     ctx.clearRect(0,0, canvas.width, canvas.height);
                     return;
                }
                
                ctx.clearRect(0,0, canvas.width, canvas.height);
                
                particles.forEach(p => {
                    p.vy += 0.05; 
                    p.x += p.vx + Math.sin(p.y * 0.01); 
                    p.y += p.vy;
                    p.angle += p.spin;

                    if(p.y > canvas.height) {
                        p.y = -10;
                        p.x = Math.random() * canvas.width;
                        p.vy = Math.random() * 2 + 2;
                    }

                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.angle * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    ctx.restore();
                });
                
                confettiAnimationId = requestAnimationFrame(animate);
            }
            if(confettiAnimationId) cancelAnimationFrame(confettiAnimationId);
            animate();
        }

        function stopConfetti() {
            if(confettiAnimationId) {
                cancelAnimationFrame(confettiAnimationId);
                confettiAnimationId = null;
                const canvas = document.getElementById('confetti-canvas');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0,0, canvas.width, canvas.height);
                }
            }
        }

        const game = new Game();
        window.onload = () => game.init();

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
